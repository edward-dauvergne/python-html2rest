#!/usr/bin/env python

import sys
import urllib
import codecs
import locale
from optparse import OptionParser

from html2rest import html2rest


def arguments():
    """Process the command line arguments."""

    # Set up the parser object.
    parser = OptionParser(usage="usage: %prog [URL/file]")

    # Add the options.
    parser.add_option('-e', '--encoding', action='store', type='string', dest='encoding', default=(locale.getpreferredencoding() or 'utf8'), help='choose the text encoding')
    parser.add_option('-r', '--relto', action='store', type='string', dest='relto', help='set the relative path')
    parser.add_option('--no-wrap', action='store_true', dest='nowrap', default=0, help='disable line wrapping')

    # Parse the options.
    options, args = parser.parse_args()

    # Process the URL or file name.
    if len(args) > 1:
        parser.error("unknown arguments")
    fileobj = sys.stdin
    if len(args):
        if '://' in args[0]:
            fileobj = urllib.urlopen(args[0])
        else:
            fileobj = open(arg, 'rb')

    # Return the arguments.
    return fileobj, options


# Parse the arguments.
fileobj, options = arguments()

# Execute.
try:
    html2rest(fileobj.read(), encoding=options.encoding, relto=options.relto, options.nowrap)
finally:
    try:
        fileobj.close()
    except:
        pass
